name: Ansible Deploy (triggered by infra)

on:
  workflow_run:
    workflows: ["Infrastructure Deployment"]
    types: [completed]
  workflow_dispatch: 

permissions:
  contents: read
  id-token: write

env:
  TF_VERSION: '1.6.0'
  PYTHON_VERSION: '3.11'

jobs:
  deploy:
    # only run when infra workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    # bring secrets into env so they can be referenced in `if:` expressions
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
      SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
      SMTP_FROM_EMAIL: ${{ secrets.SMTP_FROM_EMAIL }}
      NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (for remote backend / provider access)
        # only run if both AWS credentials are set in env (safe check)
        if: ${{ env.AWS_ACCESS_KEY_ID != '' && env.AWS_SECRET_ACCESS_KEY != '' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform init (use same backend as infra)
        working-directory: ./infra/terraform
        run: |
          terraform init -input=false

      - name: Export Ansible files from terraform outputs
        working-directory: ./infra/terraform
        run: |
          # ensure ansible folder exists in checked-out repo workspace
          mkdir -p ../../ansible/group_vars

          # extract outputs (must match exact output names in Terraform)
          terraform output -raw ansible_inventory  > ../../ansible/inventory.ini
          terraform output -raw ansible_group_vars > ../../ansible/group_vars/all.json

          echo "Inventory and group_vars written to ./ansible"
          ls -la ../../ansible || true

      - name: Setup Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Ansible
        run: |
          python -m pip install --upgrade pip
          pip install ansible

      - name: Ensure SSH private key is present
        run: |
          mkdir -p ~/.ssh
          printf '%s' "${{ env.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

      - name: (Optional) convert group_vars JSON -> YAML
        run: |
          if [ -f ./ansible/group_vars/all.json ]; then
            python - <<'PY'
            import json, pathlib, yaml
            p = pathlib.Path('ansible/group_vars/all.json')
            obj = json.loads(p.read_text())
            out = pathlib.Path('ansible/group_vars/all.yml')
            out.write_text(yaml.safe_dump(obj, sort_keys=False))
            print('wrote', out)
            PY
           fi

      - name: Run Ansible Playbook
        working-directory: ./ansible
        run: |
          export ANSIBLE_HOST_KEY_CHECKING=False
          chmod 600 ~/.ssh/id_ed25519
          ansible-playbook -i inventory.ini site.yml --private-key ~/.ssh/id_ed25519 -vv

      - name: Send deployment completion email (optional)
        if: ${{ env.SMTP_SERVER != '' && env.SMTP_USERNAME != '' }}
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ env.SMTP_SERVER }}
          server_port: ${{ env.SMTP_PORT }}
          username: ${{ env.SMTP_USERNAME }}
          password: ${{ env.SMTP_PASSWORD }}
          subject: "Ansible deployment completed"
          to: ${{ env.NOTIFICATION_EMAIL }}
          from: ${{ env.SMTP_FROM_EMAIL }}
          body: |
            Ansible deployment completed for infra workflow run: ${{ github.event.workflow_run.id }}
