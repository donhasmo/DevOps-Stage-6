name: Application Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
      - '.env'
      - '.github/workflows/application.yml'
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  test-build:
    name: Test Docker Builds
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          cat > .env << EOF
          DOMAIN=${{ secrets.DOMAIN_NAME }}
          ACME_EMAIL=${{ secrets.ACME_EMAIL }}
          PORT=8080
          AUTH_API_ADDRESS=http://auth-api:8081
          TODOS_API_ADDRESS=http://todos-api:8082
          AUTH_API_PORT=8081
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          USERS_API_ADDRESS=http://users-api:8083
          REDIS_HOST=redis-queue
          REDIS_PORT=6379
          REDIS_CHANNEL=log_channel
          SERVER_PORT=8083
          EOF

      - name: Test Frontend Build
        run: docker build -t frontend:test ./frontend

      - name: Test Auth API Build
        run: docker build -t auth-api:test ./auth-api

      - name: Test Todos API Build
        run: docker build -t todos-api:test ./todos-api

      - name: Test Users API Build
        run: docker build -t users-api:test ./users-api

      - name: Test Log Processor Build
        run: docker build -t log-processor:test ./log-message-processor

      - name: Test Docker Compose
        run: |
          docker compose config
          echo "Docker Compose configuration is valid"

  deploy-application:
    name: Deploy Application to Server
    runs-on: ubuntu-latest
    needs: test-build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform (to get server IP)
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
          terraform_wrapper: false

      - name: Get Server IP from Terraform
        id: terraform_output
        working-directory: ./infra/terraform
        run: |
          terraform init
          SERVER_IP=$(terraform output -raw instance_public_ip 2>/dev/null || echo "")
          if [ -z "$SERVER_IP" ]; then
            echo "Error: Could not get server IP from Terraform"
            exit 1
          fi
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "Server IP: $SERVER_IP"

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ steps.terraform_output.outputs.server_ip }} >> ~/.ssh/known_hosts

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Generate Ansible Inventory
        working-directory: ./infra/ansible
        run: |
          cat > inventory.ini << EOF
          [microservices]
          ${{ steps.terraform_output.outputs.server_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/deploy_key
          
          [microservices:vars]
          ansible_python_interpreter=/usr/bin/python3
          domain_name=${{ secrets.DOMAIN_NAME }}
          acme_email=${{ secrets.ACME_EMAIL }}
          git_repo_url=${{ secrets.GIT_REPO_URL }}
          git_branch=main
          jwt_secret=${{ secrets.JWT_SECRET }}
          EOF

      - name: Run Ansible Deployment
        working-directory: ./infra/ansible
        run: |
          ansible-playbook -i inventory.ini playbook.yml -v

      - name: Verify Deployment
        run: |
          echo "Waiting for services to be ready..."
          sleep 30
          
          # Check if server is responding
          if curl -f -k https://${{ secrets.DOMAIN_NAME }} > /dev/null 2>&1; then
            echo "Application is accessible at https://${{ secrets.DOMAIN_NAME }}"
          else
            echo "Application may not be ready yet. Please check manually."
          fi

      - name: Display Deployment Info
        run: |
          echo "Deployment completed successfully!"

  send-deployment-notification:
    name: Send Deployment Notification
    runs-on: ubuntu-latest
    needs: deploy-application
    if: always()
    
    steps:
      - name: Send Success Email
        if: needs.deploy-application.result == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Application Deployment Successful"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.SMTP_FROM_EMAIL }}
          body: |
            Application Deployment Completed Successfully!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Deployed by: ${{ github.actor }}
            
            Your application is now live at: https://${{ secrets.DOMAIN_NAME }}
            
            Workflow: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            This is an automated notification from the CI/CD pipeline.
          html_body: |
            <h2>Application Deployment Successful</h2>
            <p>Your application has been deployed successfully!</p>
            
            <h3>Details:</h3>
            <ul>
              <li><strong>Repository:</strong> ${{ github.repository }}</li>
              <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
              <li><strong>Commit:</strong> ${{ github.sha }}</li>
              <li><strong>Deployed by:</strong> ${{ github.actor }}</li>
            </ul>
            
            <h3>ðŸ”— Links:</h3>
            <ul>
              <li><a href="https://${{ secrets.DOMAIN_NAME }}">Application URL</a></li>
              <li><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Workflow Run</a></li>
            </ul>
            
            <hr>
            <p><small>This is an automated notification from the CI/CD pipeline.</small></p>

      - name: Send Failure Email
        if: needs.deploy-application.result == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "Application Deployment Failed"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.SMTP_FROM_EMAIL }}
          body: |
            Application Deployment Failed!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
            
            Please check the workflow logs for details:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            This is an automated notification from the CI/CD pipeline.
          html_body: |
            <h2>Application Deployment Failed</h2>
            <p>The application deployment has failed. Please review the logs.</p>
            
            <h3>Details:</h3>
            <ul>
              <li><strong>Repository:</strong> ${{ github.repository }}</li>
              <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
              <li><strong>Commit:</strong> ${{ github.sha }}</li>
              <li><strong>Triggered by:</strong> ${{ github.actor }}</li>
            </ul>
            
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Logs</a></p>
            
            <hr>
            <p><small>This is an automated notification from the CI/CD pipeline.</small></p>